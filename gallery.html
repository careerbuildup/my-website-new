<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Collaboration BD - Video Playlist</title>

    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ==========================
           GLOBAL RESET + VARIABLES
        ========================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root{
            --bg-color: #ffffff;
            --text-main: #000000;
            --text-light: #adb5bd;
            --primary: #4263eb;
            --shadow-light: #ffffff;
            --shadow-dark: #dee2e6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            color: #495057; 
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 5px;
        }

        .header {
            background-color: #ffffff;
            padding: 10px 0;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            text-decoration: none;
            color: #000000;
            display: flex;
            align-items: center;
        }

        .logo-icon {
            background-color: #4263eb;
            color: #fff;
            padding: 6px 12px;
            border-radius: 8px;
            margin-right: 10px;
            font-weight: bold;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2), -5px -5px 10px rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 5px;
        }

        .nav-links a {
            text-decoration: none;
            color: #000000;
            font-weight: 500;
            font-size: 12px;
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            color: #4263eb;
            box-shadow: inset 5px 5px 10px #dee2e6, inset -5px -5px 10px #ffffff;
        }

        .auth-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .signout-btn {
            text-decoration: none;
            background-color: #4263eb;
            color: #fff;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 12px;
            border: none;
            cursor: pointer;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2), -5px -5px 10px rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .signout-btn:hover {
            box-shadow: inset 3px 3px 7px rgba(0, 0, 0, 0.2), inset -3px -3px 7px rgba(255, 255, 255, 0.1);
        }

        /* Gallery Styles */
        .gallery-section{
            padding: 40px 0 100px;
            background: var(--bg-color);
        }

        h1{
            text-align: center;
            margin-bottom: 40px;
            font-weight: 700;
            color: #000000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .video-grid{
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
        }

        .video-card{
            background-color: var(--bg-color);
            border-radius: 20px;
            padding: 15px;
            position: relative;
            box-shadow: 9px 9px 16px var(--shadow-dark), -9px -9px 16px var(--shadow-light);
            transition: transform 0.3s ease;
        }

        .video-card:hover{
            transform: translateY(-5px);
        }

        .thumbnail-container{
            width: 100%;
            height: 160px;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .thumbnail-container img{
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .thumbnail-container:hover img{
            transform: scale(1.05);
        }

        .play-icon-overlay{
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: rgba(255,255,255,0.9);
            pointer-events: none;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .card-info{
            padding: 15px 5px 5px 5px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .video-title{
            font-size: 14px;
            font-weight: 600;
            color: #000000;
            line-height: 1.4;
            margin-right: 10px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-actions{
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn, .up-btn, .down-btn{
            background: var(--bg-color);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            transition: all 0.2s ease;
        }

        .edit-btn{ color: #0d6efd; }
        .delete-btn{ color: #dc3545; }
        .up-btn, .down-btn{ color: #343a40; }

        .fab-container{
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 100;
        }

        .add-btn{
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--bg-color);
            border: none;
            color: var(--primary);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            transition: all 0.3s ease;
        }

        .add-btn:hover{ color: #364fc7; transform: scale(1.1); }

        /* Modals */
        .modal-overlay{
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 244, 248, 0.85);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active{ display: flex; opacity: 1; }

        .modal-content{
            background-color: var(--bg-color);
            padding: 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 15px 15px 30px var(--shadow-dark), -15px -15px 30px var(--shadow-light);
            text-align: center;
            position: relative;
        }

        .modal-title{
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--primary);
        }

        .input-group{ margin-bottom: 20px; text-align: left; }
        .input-group label{ display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; }

        .neumorphic-input{
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: var(--bg-color);
            color: var(--text-main);
            outline: none;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
        }

        .modal-actions{
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .btn{
            padding: 10px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            background: var(--bg-color);
            transition: all 0.2s;
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
        }
        .btn-primary{ color: var(--primary); }
        .btn-cancel{ color: #6c757d; }

        /* Player Modal */
        .player-content{ max-width: 800px; width: 95%; padding: 20px; }
        .video-wrapper{
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: inset 5px 5px 10px var(--shadow-dark), inset -5px -5px 10px var(--shadow-light);
            background: #000;
        }
        .video-wrapper iframe{
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;
        }
        .close-player{
            position: absolute; top: -15px; right: -15px; width: 40px; height: 40px;
            border-radius: 50%; background: var(--bg-color); color: #dc3545;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            font-size: 18px; border: none; box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
        }

        .empty-state{
            text-align: center; margin-top: 50px; color: var(--text-light); display: none;
        }

        /* Loading Indicator */
        .loading-indicator {
            text-align: center;
            font-size: 18px;
            margin-top: 50px;
            color: var(--primary);
            display: none;
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="index1.html" class="logo">
                    <span class="logo-icon">IT</span> Collaboration BD
                </a>
                <ul class="nav-links">
                    <li><a href="index1.html">Home</a></li>
                    <li><a href="project.html">Project</a></li>
                    <li><a href="explore.html">Explore</a></li>
                    <li><a href="contact.html">Contact us</a></li>
                    <li><a href="about.html">About us</a></li>
                </ul>
                <div class="auth-buttons">
                    <!-- Signout Button -->
                    <a href="index.html" class="signout-btn">Sign out</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- MAIN VIDEO GALLERY -->
    <main class="gallery-section">
        <div class="container">
            <h1 id="playlistTitle">Playlist</h1>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="loading-indicator">Loading your videos...</div>
            
            <div class="video-grid" id="videoGrid"></div>

            <div class="empty-state" id="emptyState">
                <h3>No videos added yet. Click the + button!</h3>
            </div>
        </div>
    </main>

    <!-- Floating Add Button -->
    <div class="fab-container">
        <button class="add-btn" id="openModalBtn">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <!-- Add Video Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <h3 class="modal-title">Add New Video</h3>
            <div class="input-group">
                <label>Video Title</label>
                <input type="text" id="videoTitle" class="neumorphic-input" placeholder="Enter video title...">
            </div>
            <div class="input-group">
                <label>Video Link (YouTube/MP4/Drive)</label>
                <input type="text" id="videoLink" class="neumorphic-input" placeholder="Paste video URL here...">
            </div>
            <div class="input-group">
                <label>Poster Image URL (optional)</label>
                <input type="text" id="videoPoster" class="neumorphic-input" placeholder="Paste poster image URL...">
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" id="cancelBtn">Cancel</button>
                <button class="btn btn-primary" id="addVideoBtn">Add Video</button>
            </div>
        </div>
    </div>

    <!-- Player Modal -->
    <div class="modal-overlay" id="playerModal">
        <div class="modal-content player-content">
            <button class="close-player" id="closePlayerBtn">
                <i class="fa-solid fa-times"></i>
            </button>
            <div class="video-wrapper">
                <iframe id="youtubeIframe" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration & Logic -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBHV3LF6IVV9j6Mbj45alh7ZM1umTt5T_s",
            authDomain: "it-collaboration-bd-d9d49.firebaseapp.com",
            projectId: "it-collaboration-bd-d9d49",
            storageBucket: "it-collaboration-bd-d9d49.firebasestorage.app",
            messagingSenderId: "620180048968",
            appId: "1:620180048968:web:a020267d4250e50a091c7d",
            measurementId: "G-MD3WBCZVLT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --------------------
        // DOM Elements
        // --------------------
        const grid = document.getElementById('videoGrid');
        const emptyState = document.getElementById('emptyState');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const addModal = document.getElementById('addModal');
        const playerModal = document.getElementById('playerModal');
        const iframe = document.getElementById('youtubeIframe');
        const playlistTitleEl = document.getElementById('playlistTitle');

        const openModalBtn = document.getElementById('openModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const addVideoBtn = document.getElementById('addVideoBtn');
        const closePlayerBtn = document.getElementById('closePlayerBtn');

        const titleInput = document.getElementById('videoTitle');
        const linkInput = document.getElementById('videoLink');
        const posterInput = document.getElementById('videoPoster');

        // --------------------
        // Data & State
        // --------------------
        let videos = [];
        let playlistId = 'default';
        let currentUser = null;
        let firestoreFieldKey = 'playlist_default'; // Default key

        // --------------------
        // Auth Listener & Init
        // --------------------
        document.addEventListener('DOMContentLoaded', () => {
            // URL থেকে Playlist ID নেওয়া
            const urlParams = new URLSearchParams(window.location.search);
            const idFromUrl = urlParams.get('playlist');

            if (idFromUrl) {
                playlistId = idFromUrl;
                // [গুরুত্বপূর্ণ পরিবর্তন] 
                // ক্যাটাগরি অনুযায়ী আলাদা আলাদা কী (Key) তৈরি করা হচ্ছে
                firestoreFieldKey = `playlist_${playlistId}`; 
                
                const formattedTitle = playlistId.replace(/[-_]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + ' Videos';
                playlistTitleEl.textContent = formattedTitle;
            } else {
                 playlistTitleEl.textContent = 'My Default Playlist';
            }
        });

        // Check Login Status
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadDataFromFirestore(); // Load specific playlist data
            } else {
                window.location.replace("login.html");
            }
        });

        // Sign Out Logic
        document.getElementById('signoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => {
                alert("Signed out successfully!");
                window.location.replace("login.html");
            }).catch((error) => {
                console.error("Sign Out Error", error);
            });
        });

        // --------------------
        // Firestore Logic (Cloud Save/Load) - Dynamic Keys
        // --------------------
        
        async function saveDataToFirestore() {
            if (!currentUser) return;
            try {
                // [গুরুত্বপূর্ণ] { merge: true } এবং ডায়নামিক কী [firestoreFieldKey] ব্যবহার করা হচ্ছে
                // এর ফলে অন্য ক্যাটাগরির ডাটা ডিলিট হবে না
                await setDoc(doc(db, "users_data", currentUser.uid), {
                    [firestoreFieldKey]: videos
                }, { merge: true });
                
                renderVideos();
            } catch (error) {
                console.error("Error saving data:", error);
                alert("Failed to save to cloud. Check console.");
            }
        }

        async function loadDataFromFirestore() {
            if (!currentUser) return;
            loadingIndicator.style.display = 'block';
            grid.innerHTML = '';

            try {
                const docRef = doc(db, "users_data", currentUser.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // শুধুমাত্র বর্তমান Playlist এর ডাটা লোড করা হচ্ছে
                    videos = data[firestoreFieldKey] || [];
                } else {
                    videos = [];
                }
            } catch (error) {
                console.error("Error loading data:", error);
            } finally {
                loadingIndicator.style.display = 'none';
                renderVideos();
            }
        }

        // --------------------
        // Standard Functions
        // --------------------
        openModalBtn.addEventListener('click', () => {
            addModal.classList.add('active');
            titleInput.value = ''; linkInput.value = ''; posterInput.value = '';
        });

        cancelBtn.addEventListener('click', () => addModal.classList.remove('active'));
        addVideoBtn.addEventListener('click', addVideo);
        closePlayerBtn.addEventListener('click', closePlayer);

        function renderVideos() {
            grid.innerHTML = '';
            if (videos.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            emptyState.style.display = 'none';

            videos.forEach((video, index) => {
                const card = document.createElement('div');
                card.className = 'video-card';
                const thumb = video.poster || getThumbnail(video);

                card.innerHTML = `
                  <div class="thumbnail-container">
                    <img src="${thumb}" alt="Thumbnail" onerror="this.src='https://i.imgur.com/2yY4ZQh.png';">
                    <div class="play-icon-overlay"><i class="fa-solid fa-play"></i></div>
                  </div>
                  <div class="card-info">
                    <div class="video-title">${index + 1}. ${video.title}</div>
                    <div class="video-actions">
                      <button class="up-btn" title="Move Up">⬆</button>
                      <button class="down-btn" title="Move Down">⬇</button>
                      <button class="edit-btn" title="Rename"><i class="fa-solid fa-pen"></i></button>
                      <button class="delete-btn" title="Delete"><i class="fa-solid fa-trash"></i></button>
                    </div>
                  </div>
                `;

                card.querySelector('.thumbnail-container').addEventListener('click', () => playVideo(video));
                card.querySelector('.edit-btn').addEventListener('click', () => renameVideo(index));
                card.querySelector('.delete-btn').addEventListener('click', () => deleteVideo(index));
                card.querySelector('.up-btn').addEventListener('click', () => moveUp(index));
                card.querySelector('.down-btn').addEventListener('click', () => moveDown(index));
                
                grid.appendChild(card);
            });
        }

        function addVideo() {
            const title = titleInput.value.trim();
            let url = linkInput.value.trim();
            const poster = posterInput.value.trim();

            if (!title || !url) { alert("Please fill in both fields!"); return; }
            
            if (url.includes("drive.google.com") && !url.includes("/preview")) {
                const converted = convertDriveLink(url);
                if (!converted) { alert("Invalid Drive link!"); return; }
                url = converted;
            }
            
            const type = detectType(url);
            if (!type) { alert("Invalid link! Use YouTube or Drive preview link."); return; }
            
            const video = { type, src: url, title, poster: poster || null };
            videos.push(video);
            
            saveDataToFirestore(); 
            addModal.classList.remove('active');
        }

        function deleteVideo(index) {
            if (confirm("Delete this video?")) {
                videos.splice(index, 1);
                saveDataToFirestore();
            }
        }

        function moveUp(index) {
            if (index === 0) return;
            [videos[index - 1], videos[index]] = [videos[index], videos[index - 1]];
            saveDataToFirestore();
        }

        function moveDown(index) {
            if (index === videos.length - 1) return;
            [videos[index + 1], videos[index]] = [videos[index], videos[index + 1]];
            saveDataToFirestore();
        }

        function renameVideo(index) {
            const newTitle = prompt("Enter new video title:", videos[index].title);
            if (newTitle && newTitle.trim()) {
                videos[index].title = newTitle.trim();
                saveDataToFirestore();
            }
        }

        // Helper Functions
        function playVideo(video) {
            iframe.src = "";
            let videoUrl = '';
            if (video.type === "youtube") {
                const id = extractYouTubeID(video.src);
                if (id) videoUrl = `https://www.youtube.com/embed/${id}?autoplay=1`;
            } else if (video.type === "drive" || video.type === "mp4") {
                videoUrl = video.src;
            }
            if (videoUrl) {
                iframe.src = videoUrl;
                playerModal.classList.add("active");
            } else {
                alert("Could not play the video. Invalid URL.");
            }
        }

        function closePlayer() {
            iframe.src = "";
            playerModal.classList.remove("active");
        }

        function detectType(url) {
            try {
                const u = new URL(url);
                if (u.hostname.includes("youtube.com") || u.hostname.includes("youtu.be")) return "youtube";
                if (url.includes("drive.google.com") && url.includes("/preview")) return "drive";
                if (url.endsWith(".mp4")) return "mp4";
                return null;
            } catch {
                if (url.endsWith(".mp4")) return "mp4";
                return null;
            }
        }

        function convertDriveLink(url) {
            const match = url.match(/\/file\/d\/(.*?)\//);
            if (match && match[1]) {
                return `https://drive.google.com/file/d/${match[1]}/preview`;
            }
            return null;
        }

        function getThumbnail(video) {
            if (video.type === "youtube") {
                const id = extractYouTubeID(video.src);
                if (id) return `https://img.youtube.com/vi/${id}/mqdefault.jpg`;
            }
            return "https://i.imgur.com/2yY4ZQh.png";
        }

        function extractYouTubeID(url) {
            try {
                const u = new URL(url);
                if (u.hostname === "youtu.be") return u.pathname.slice(1);
                if (u.searchParams.get("v")) return u.searchParams.get("v");
                if (u.pathname.includes("/shorts/")) return u.pathname.split("/shorts/")[1];
                if (u.pathname.includes("/embed/")) return u.pathname.split("/embed/")[1];
                return null;
            } catch { return null; }
        }
    </script>
</body>
</html>